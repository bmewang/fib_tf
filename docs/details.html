<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8" />
      <title>details</title>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: [],
    TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"],
      equationNumbers: { autoNumber: "all" }
    },
    showMathMenu: false
  });
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>
      <style>body { padding: 0; margin: 0; }
.markdown-preview-plus-view:not([data-use-github-style]) { padding: 2em; font-size: 1.2em; color: rgb(56, 58, 66); background-color: rgb(250, 250, 250); overflow: auto; }
.markdown-preview-plus-view:not([data-use-github-style]) > :first-child { margin-top: 0px; }
.markdown-preview-plus-view:not([data-use-github-style]) h1, .markdown-preview-plus-view:not([data-use-github-style]) h2, .markdown-preview-plus-view:not([data-use-github-style]) h3, .markdown-preview-plus-view:not([data-use-github-style]) h4, .markdown-preview-plus-view:not([data-use-github-style]) h5, .markdown-preview-plus-view:not([data-use-github-style]) h6 { line-height: 1.2; margin-top: 1.5em; margin-bottom: 0.5em; color: rgb(0, 0, 0); }
.markdown-preview-plus-view:not([data-use-github-style]) h1 { font-size: 2.4em; font-weight: 300; }
.markdown-preview-plus-view:not([data-use-github-style]) h2 { font-size: 1.8em; font-weight: 400; }
.markdown-preview-plus-view:not([data-use-github-style]) h3 { font-size: 1.5em; font-weight: 500; }
.markdown-preview-plus-view:not([data-use-github-style]) h4 { font-size: 1.2em; font-weight: 600; }
.markdown-preview-plus-view:not([data-use-github-style]) h5 { font-size: 1.1em; font-weight: 600; }
.markdown-preview-plus-view:not([data-use-github-style]) h6 { font-size: 1em; font-weight: 600; }
.markdown-preview-plus-view:not([data-use-github-style]) strong { color: rgb(0, 0, 0); }
.markdown-preview-plus-view:not([data-use-github-style]) del { color: rgb(94, 97, 110); }
.markdown-preview-plus-view:not([data-use-github-style]) a, .markdown-preview-plus-view:not([data-use-github-style]) a code { color: rgb(82, 111, 255); }
.markdown-preview-plus-view:not([data-use-github-style]) img { max-width: 100%; }
.markdown-preview-plus-view:not([data-use-github-style]) > p { margin-top: 0px; margin-bottom: 1.5em; }
.markdown-preview-plus-view:not([data-use-github-style]) > ul, .markdown-preview-plus-view:not([data-use-github-style]) > ol { margin-bottom: 1.5em; }
.markdown-preview-plus-view:not([data-use-github-style]) blockquote { margin: 1.5em 0px; font-size: inherit; color: rgb(94, 97, 110); border-color: rgb(209, 209, 210); border-width: 4px; }
.markdown-preview-plus-view:not([data-use-github-style]) hr { margin: 3em 0px; border-top: 2px dashed rgb(209, 209, 210); background: none; }
.markdown-preview-plus-view:not([data-use-github-style]) table { margin: 1.5em 0px; }
.markdown-preview-plus-view:not([data-use-github-style]) th { color: rgb(0, 0, 0); }
.markdown-preview-plus-view:not([data-use-github-style]) th, .markdown-preview-plus-view:not([data-use-github-style]) td { padding: 0.66em 1em; border: 1px solid rgb(209, 209, 210); }
.markdown-preview-plus-view:not([data-use-github-style]) pre, .markdown-preview-plus-view:not([data-use-github-style]) code { color: rgb(0, 0, 0); background-color: rgb(234, 234, 235); }
.markdown-preview-plus-view:not([data-use-github-style]) pre, .markdown-preview-plus-view:not([data-use-github-style]) pre.editor-colors { margin: 1.5em 0px; padding: 1em; font-size: 0.92em; border-radius: 3px; background-color: rgb(240, 240, 240); }
.markdown-preview-plus-view:not([data-use-github-style]) kbd { color: rgb(0, 0, 0); border-width: 1px 1px 2px; border-style: solid; border-color: rgb(209, 209, 210) rgb(209, 209, 210) rgb(193, 193, 194); border-image: initial; background-color: rgb(234, 234, 235); }
.markdown-preview-plus-view:not([data-use-github-style]) ul.contains-task-list li.task-list-item { position: relative; list-style-type: none; }
.markdown-preview-plus-view:not([data-use-github-style]) ul.contains-task-list li.task-list-item input.task-list-item-checkbox { position: absolute; transform: translateX(-100%); width: 30px; }
.markdown-preview-plus-view[data-use-github-style] { font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif; line-height: 1.6; word-wrap: break-word; padding: 30px; font-size: 16px; color: rgb(51, 51, 51); background-color: rgb(255, 255, 255); overflow: auto; }
.markdown-preview-plus-view[data-use-github-style] > :first-child { margin-top: 0px !important; }
.markdown-preview-plus-view[data-use-github-style] > :last-child { margin-bottom: 0px !important; }
.markdown-preview-plus-view[data-use-github-style] a:not([href]) { color: inherit; text-decoration: none; }
.markdown-preview-plus-view[data-use-github-style] .absent { color: rgb(204, 0, 0); }
.markdown-preview-plus-view[data-use-github-style] .anchor { position: absolute; top: 0px; left: 0px; display: block; padding-right: 6px; padding-left: 30px; margin-left: -30px; }
.markdown-preview-plus-view[data-use-github-style] .anchor:focus { outline: none; }
.markdown-preview-plus-view[data-use-github-style] h1, .markdown-preview-plus-view[data-use-github-style] h2, .markdown-preview-plus-view[data-use-github-style] h3, .markdown-preview-plus-view[data-use-github-style] h4, .markdown-preview-plus-view[data-use-github-style] h5, .markdown-preview-plus-view[data-use-github-style] h6 { position: relative; margin-top: 1em; margin-bottom: 16px; font-weight: bold; line-height: 1.4; }
.markdown-preview-plus-view[data-use-github-style] h1 .octicon-link, .markdown-preview-plus-view[data-use-github-style] h2 .octicon-link, .markdown-preview-plus-view[data-use-github-style] h3 .octicon-link, .markdown-preview-plus-view[data-use-github-style] h4 .octicon-link, .markdown-preview-plus-view[data-use-github-style] h5 .octicon-link, .markdown-preview-plus-view[data-use-github-style] h6 .octicon-link { display: none; color: rgb(0, 0, 0); vertical-align: middle; }
.markdown-preview-plus-view[data-use-github-style] h1:hover .anchor, .markdown-preview-plus-view[data-use-github-style] h2:hover .anchor, .markdown-preview-plus-view[data-use-github-style] h3:hover .anchor, .markdown-preview-plus-view[data-use-github-style] h4:hover .anchor, .markdown-preview-plus-view[data-use-github-style] h5:hover .anchor, .markdown-preview-plus-view[data-use-github-style] h6:hover .anchor { padding-left: 8px; margin-left: -30px; text-decoration: none; }
.markdown-preview-plus-view[data-use-github-style] h1:hover .anchor .octicon-link, .markdown-preview-plus-view[data-use-github-style] h2:hover .anchor .octicon-link, .markdown-preview-plus-view[data-use-github-style] h3:hover .anchor .octicon-link, .markdown-preview-plus-view[data-use-github-style] h4:hover .anchor .octicon-link, .markdown-preview-plus-view[data-use-github-style] h5:hover .anchor .octicon-link, .markdown-preview-plus-view[data-use-github-style] h6:hover .anchor .octicon-link { display: inline-block; }
.markdown-preview-plus-view[data-use-github-style] h1 tt, .markdown-preview-plus-view[data-use-github-style] h2 tt, .markdown-preview-plus-view[data-use-github-style] h3 tt, .markdown-preview-plus-view[data-use-github-style] h4 tt, .markdown-preview-plus-view[data-use-github-style] h5 tt, .markdown-preview-plus-view[data-use-github-style] h6 tt, .markdown-preview-plus-view[data-use-github-style] h1 code, .markdown-preview-plus-view[data-use-github-style] h2 code, .markdown-preview-plus-view[data-use-github-style] h3 code, .markdown-preview-plus-view[data-use-github-style] h4 code, .markdown-preview-plus-view[data-use-github-style] h5 code, .markdown-preview-plus-view[data-use-github-style] h6 code { font-size: inherit; }
.markdown-preview-plus-view[data-use-github-style] h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom: 1px solid rgb(238, 238, 238); }
.markdown-preview-plus-view[data-use-github-style] h1 .anchor { line-height: 1; }
.markdown-preview-plus-view[data-use-github-style] h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom: 1px solid rgb(238, 238, 238); }
.markdown-preview-plus-view[data-use-github-style] h2 .anchor { line-height: 1; }
.markdown-preview-plus-view[data-use-github-style] h3 { font-size: 1.5em; line-height: 1.43; }
.markdown-preview-plus-view[data-use-github-style] h3 .anchor { line-height: 1.2; }
.markdown-preview-plus-view[data-use-github-style] h4 { font-size: 1.25em; }
.markdown-preview-plus-view[data-use-github-style] h4 .anchor { line-height: 1.2; }
.markdown-preview-plus-view[data-use-github-style] h5 { font-size: 1em; }
.markdown-preview-plus-view[data-use-github-style] h5 .anchor { line-height: 1.1; }
.markdown-preview-plus-view[data-use-github-style] h6 { font-size: 1em; color: rgb(119, 119, 119); }
.markdown-preview-plus-view[data-use-github-style] h6 .anchor { line-height: 1.1; }
.markdown-preview-plus-view[data-use-github-style] p, .markdown-preview-plus-view[data-use-github-style] blockquote, .markdown-preview-plus-view[data-use-github-style] ul, .markdown-preview-plus-view[data-use-github-style] ol, .markdown-preview-plus-view[data-use-github-style] dl, .markdown-preview-plus-view[data-use-github-style] table, .markdown-preview-plus-view[data-use-github-style] pre { margin-top: 0px; margin-bottom: 16px; }
.markdown-preview-plus-view[data-use-github-style] hr { height: 4px; padding: 0px; margin: 16px 0px; background-color: rgb(231, 231, 231); border: 0px none; }
.markdown-preview-plus-view[data-use-github-style] ul, .markdown-preview-plus-view[data-use-github-style] ol { padding-left: 2em; }
.markdown-preview-plus-view[data-use-github-style] ul.no-list, .markdown-preview-plus-view[data-use-github-style] ol.no-list { padding: 0px; list-style-type: none; }
.markdown-preview-plus-view[data-use-github-style] ul ul, .markdown-preview-plus-view[data-use-github-style] ul ol, .markdown-preview-plus-view[data-use-github-style] ol ol, .markdown-preview-plus-view[data-use-github-style] ol ul { margin-top: 0px; margin-bottom: 0px; }
.markdown-preview-plus-view[data-use-github-style] li > p { margin-top: 16px; }
.markdown-preview-plus-view[data-use-github-style] dl { padding: 0px; }
.markdown-preview-plus-view[data-use-github-style] dl dt { padding: 0px; margin-top: 16px; font-size: 1em; font-style: italic; font-weight: bold; }
.markdown-preview-plus-view[data-use-github-style] dl dd { padding: 0px 16px; margin-bottom: 16px; }
.markdown-preview-plus-view[data-use-github-style] blockquote { padding: 0px 15px; color: rgb(119, 119, 119); border-left: 4px solid rgb(221, 221, 221); }
.markdown-preview-plus-view[data-use-github-style] blockquote > :first-child { margin-top: 0px; }
.markdown-preview-plus-view[data-use-github-style] blockquote > :last-child { margin-bottom: 0px; }
.markdown-preview-plus-view[data-use-github-style] table { display: block; width: 100%; overflow: auto; word-break: keep-all; }
.markdown-preview-plus-view[data-use-github-style] table th { font-weight: bold; }
.markdown-preview-plus-view[data-use-github-style] table th, .markdown-preview-plus-view[data-use-github-style] table td { padding: 6px 13px; border: 1px solid rgb(221, 221, 221); }
.markdown-preview-plus-view[data-use-github-style] table tr { background-color: rgb(255, 255, 255); border-top: 1px solid rgb(204, 204, 204); }
.markdown-preview-plus-view[data-use-github-style] table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
.markdown-preview-plus-view[data-use-github-style] img { max-width: 100%; box-sizing: border-box; }
.markdown-preview-plus-view[data-use-github-style] .emoji { max-width: none; }
.markdown-preview-plus-view[data-use-github-style] span.frame { display: block; overflow: hidden; }
.markdown-preview-plus-view[data-use-github-style] span.frame > span { display: block; float: left; width: auto; padding: 7px; margin: 13px 0px 0px; overflow: hidden; border: 1px solid rgb(221, 221, 221); }
.markdown-preview-plus-view[data-use-github-style] span.frame span img { display: block; float: left; }
.markdown-preview-plus-view[data-use-github-style] span.frame span span { display: block; padding: 5px 0px 0px; clear: both; color: rgb(51, 51, 51); }
.markdown-preview-plus-view[data-use-github-style] span.align-center { display: block; overflow: hidden; clear: both; }
.markdown-preview-plus-view[data-use-github-style] span.align-center > span { display: block; margin: 13px auto 0px; overflow: hidden; text-align: center; }
.markdown-preview-plus-view[data-use-github-style] span.align-center span img { margin: 0px auto; text-align: center; }
.markdown-preview-plus-view[data-use-github-style] span.align-right { display: block; overflow: hidden; clear: both; }
.markdown-preview-plus-view[data-use-github-style] span.align-right > span { display: block; margin: 13px 0px 0px; overflow: hidden; text-align: right; }
.markdown-preview-plus-view[data-use-github-style] span.align-right span img { margin: 0px; text-align: right; }
.markdown-preview-plus-view[data-use-github-style] span.float-left { display: block; float: left; margin-right: 13px; overflow: hidden; }
.markdown-preview-plus-view[data-use-github-style] span.float-left span { margin: 13px 0px 0px; }
.markdown-preview-plus-view[data-use-github-style] span.float-right { display: block; float: right; margin-left: 13px; overflow: hidden; }
.markdown-preview-plus-view[data-use-github-style] span.float-right > span { display: block; margin: 13px auto 0px; overflow: hidden; text-align: right; }
.markdown-preview-plus-view[data-use-github-style] code, .markdown-preview-plus-view[data-use-github-style] tt { padding: 0.2em 0px; margin: 0px; font-size: 85%; background-color: rgba(0, 0, 0, 0.0392157); border-radius: 3px; }
.markdown-preview-plus-view[data-use-github-style] code::before, .markdown-preview-plus-view[data-use-github-style] tt::before, .markdown-preview-plus-view[data-use-github-style] code::after, .markdown-preview-plus-view[data-use-github-style] tt::after { letter-spacing: -0.2em; content: " "; }
.markdown-preview-plus-view[data-use-github-style] code br, .markdown-preview-plus-view[data-use-github-style] tt br { display: none; }
.markdown-preview-plus-view[data-use-github-style] del code { text-decoration: inherit; }
.markdown-preview-plus-view[data-use-github-style] pre > code { padding: 0px; margin: 0px; font-size: 100%; word-break: normal; white-space: pre; background: transparent; border: 0px; }
.markdown-preview-plus-view[data-use-github-style] .highlight { margin-bottom: 16px; }
.markdown-preview-plus-view[data-use-github-style] .highlight pre, .markdown-preview-plus-view[data-use-github-style] pre { padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45; background-color: rgb(247, 247, 247); border-radius: 3px; }
.markdown-preview-plus-view[data-use-github-style] .highlight pre { margin-bottom: 0px; word-break: normal; }
.markdown-preview-plus-view[data-use-github-style] pre { word-wrap: normal; }
.markdown-preview-plus-view[data-use-github-style] pre code, .markdown-preview-plus-view[data-use-github-style] pre tt { display: inline; max-width: initial; padding: 0px; margin: 0px; overflow: initial; line-height: inherit; word-wrap: normal; background-color: transparent; border: 0px; }
.markdown-preview-plus-view[data-use-github-style] pre code::before, .markdown-preview-plus-view[data-use-github-style] pre tt::before, .markdown-preview-plus-view[data-use-github-style] pre code::after, .markdown-preview-plus-view[data-use-github-style] pre tt::after { content: normal; }
.markdown-preview-plus-view[data-use-github-style] kbd { display: inline-block; padding: 3px 5px; font-size: 11px; line-height: 10px; color: rgb(85, 85, 85); vertical-align: middle; background-color: rgb(252, 252, 252); border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204) rgb(204, 204, 204) rgb(187, 187, 187); border-image: initial; border-radius: 3px; box-shadow: rgb(187, 187, 187) 0px -1px 0px inset; }
.markdown-preview-plus-view[data-use-github-style] a { color: rgb(51, 122, 183); }
.markdown-preview-plus-view[data-use-github-style] pre, .markdown-preview-plus-view[data-use-github-style] code { color: inherit; }
.markdown-preview-plus-view[data-use-github-style] pre, .markdown-preview-plus-view[data-use-github-style] pre.editor-colors { padding: 0.8em 1em; margin-bottom: 1em; font-size: 0.85em; border-radius: 4px; overflow: auto; }
.markdown-preview-plus-view[data-use-github-style] ul.contains-task-list li.task-list-item { position: relative; list-style-type: none; }
.markdown-preview-plus-view[data-use-github-style] ul.contains-task-list li.task-list-item input.task-list-item-checkbox { position: absolute; transform: translateX(-100%); width: 30px; }
.markdown-preview-plus-view { height: 100%; display: block; }
.markdown-preview-plus-view .emoji { max-width: 1em !important; }
.scrollbars-visible-always .markdown-preview-plus-view pre.editor-colors .vertical-scrollbar, .scrollbars-visible-always .markdown-preview-plus-view pre.editor-colors .horizontal-scrollbar { visibility: hidden; }
.scrollbars-visible-always .markdown-preview-plus-view pre.editor-colors:hover .vertical-scrollbar, .scrollbars-visible-always .markdown-preview-plus-view pre.editor-colors:hover .horizontal-scrollbar { visibility: visible; }
.markdown-preview-plus-view del { text-decoration: none; position: relative; }
.markdown-preview-plus-view del::after { border-bottom: 1px solid black; content: ""; left: 0px; position: absolute; right: 0px; top: 50%; }
.markdown-preview-plus-view .flash { animation: flash 1s ease-out 1; outline: rgba(255, 0, 0, 0) solid 1px; }
.markdown-preview-plus-view .flash:not(li) { display: block; }
.bracket-matcher .region {
  border-bottom: 1px dotted lime;
  position: absolute;
}
.line-number.bracket-matcher {
  background-color: #777;
}

.spell-check-misspelling .region {
  border-bottom: 2px dotted rgba(255, 51, 51, 0.75);
}
.spell-check-corrections {
  width: 25em !important;
}

pre.editor-colors .gutter .line-number {
  /* Use CSS specificity to force errors to override warnings and info markers */
  /* Use CSS specificity to force warnings to override info markes. */
}
pre.editor-colors .gutter .line-number.latex-error,
pre.editor-colors .gutter .line-number.latex-error.latex-warning,
pre.editor-colors .gutter .line-number.latex-error.latex-info,
pre.editor-colors .gutter .line-number.latex-error.latex-warning.latex-info {
  border-left: 2px solid #d13b2e;
  padding-left: calc(0.5em - 2px);
}
pre.editor-colors .gutter .line-number.latex-warning,
pre.editor-colors .gutter .line-number.latex-warning.latex-info {
  border-left: 2px solid #ad7c0b;
  padding-left: calc(0.5em - 2px);
}
pre.editor-colors .gutter .line-number.latex-info {
  border-left: 2px solid #0f82e6;
  padding-left: calc(0.5em - 2px);
}

pre.editor-colors {
  background-color: #fafafa;
  color: #383a42;
}
pre.editor-colors .line.cursor-line {
  background-color: rgba(56, 58, 66, 0.05);
}
pre.editor-colors .invisible {
  color: #383a42;
}
pre.editor-colors .cursor {
  border-left: 2px solid #526fff;
}
pre.editor-colors .selection .region {
  background-color: #e5e5e6;
}
pre.editor-colors .bracket-matcher .region {
  border-bottom: 1px solid #526fff;
  box-sizing: border-box;
}
pre.editor-colors .invisible-character {
  color: rgba(56, 58, 66, 0.2);
}
pre.editor-colors .indent-guide {
  color: rgba(56, 58, 66, 0.2);
}
pre.editor-colors .wrap-guide {
  background-color: rgba(56, 58, 66, 0.2);
}
pre.editor-colors .find-result .region.region.region,
pre.editor-colors .current-result .region.region.region {
  border-radius: 2px;
  background-color: rgba(82, 111, 255, 0.2);
  transition: border-color 0.4s;
}
pre.editor-colors .find-result .region.region.region {
  border: 2px solid transparent;
}
pre.editor-colors .current-result .region.region.region {
  border: 2px solid #526fff;
  transition-duration: .1s;
}
pre.editor-colors .gutter .line-number {
  color: #9d9d9f;
  -webkit-font-smoothing: antialiased;
}
pre.editor-colors .gutter .line-number.cursor-line {
  color: #383a42;
  background-color: #f2f2f2;
}
pre.editor-colors .gutter .line-number.cursor-line-no-selection {
  background-color: transparent;
}
pre.editor-colors .gutter .line-number .icon-right {
  color: #383a42;
}
pre.editor-colors .gutter:not(.git-diff-icon) .line-number.git-line-removed.git-line-removed::before {
  bottom: -3px;
}
pre.editor-colors .gutter:not(.git-diff-icon) .line-number.git-line-removed::after {
  content: "";
  position: absolute;
  left: 0px;
  bottom: 0px;
  width: 25px;
  border-bottom: 1px dotted rgba(255, 20, 20, 0.5);
  pointer-events: none;
}
pre.editor-colors .gutter .line-number.folded,
pre.editor-colors .gutter .line-number:after,
pre.editor-colors .fold-marker:after {
  color: #383a42;
}
.syntax--comment {
  color: #a0a1a7;
  font-style: italic;
}
.syntax--comment .syntax--markup.syntax--link {
  color: #a0a1a7;
}
.syntax--entity.syntax--name.syntax--type {
  color: #c18401;
}
.syntax--entity.syntax--other.syntax--inherited-class {
  color: #50a14f;
}
.syntax--keyword {
  color: #a626a4;
}
.syntax--keyword.syntax--control {
  color: #a626a4;
}
.syntax--keyword.syntax--operator {
  color: #383a42;
}
.syntax--keyword.syntax--other.syntax--special-method {
  color: #4078f2;
}
.syntax--keyword.syntax--other.syntax--unit {
  color: #986801;
}
.syntax--storage {
  color: #a626a4;
}
.syntax--storage.syntax--type.syntax--annotation,
.syntax--storage.syntax--type.syntax--primitive {
  color: #a626a4;
}
.syntax--storage.syntax--modifier.syntax--package,
.syntax--storage.syntax--modifier.syntax--import {
  color: #383a42;
}
.syntax--constant {
  color: #986801;
}
.syntax--constant.syntax--variable {
  color: #986801;
}
.syntax--constant.syntax--character.syntax--escape {
  color: #0184bc;
}
.syntax--constant.syntax--numeric {
  color: #986801;
}
.syntax--constant.syntax--other.syntax--color {
  color: #0184bc;
}
.syntax--constant.syntax--other.syntax--symbol {
  color: #0184bc;
}
.syntax--variable {
  color: #e45649;
}
.syntax--variable.syntax--interpolation {
  color: #ca1243;
}
.syntax--variable.syntax--parameter {
  color: #383a42;
}
.syntax--string {
  color: #50a14f;
}
.syntax--string.syntax--regexp {
  color: #0184bc;
}
.syntax--string.syntax--regexp .syntax--source.syntax--ruby.syntax--embedded {
  color: #c18401;
}
.syntax--string.syntax--other.syntax--link {
  color: #e45649;
}
.syntax--punctuation.syntax--definition.syntax--comment {
  color: #a0a1a7;
}
.syntax--punctuation.syntax--definition.syntax--method-parameters,
.syntax--punctuation.syntax--definition.syntax--function-parameters,
.syntax--punctuation.syntax--definition.syntax--parameters,
.syntax--punctuation.syntax--definition.syntax--separator,
.syntax--punctuation.syntax--definition.syntax--seperator,
.syntax--punctuation.syntax--definition.syntax--array {
  color: #383a42;
}
.syntax--punctuation.syntax--definition.syntax--heading,
.syntax--punctuation.syntax--definition.syntax--identity {
  color: #4078f2;
}
.syntax--punctuation.syntax--definition.syntax--bold {
  color: #c18401;
  font-weight: bold;
}
.syntax--punctuation.syntax--definition.syntax--italic {
  color: #a626a4;
  font-style: italic;
}
.syntax--punctuation.syntax--section.syntax--embedded {
  color: #ca1243;
}
.syntax--punctuation.syntax--section.syntax--method,
.syntax--punctuation.syntax--section.syntax--class,
.syntax--punctuation.syntax--section.syntax--inner-class {
  color: #383a42;
}
.syntax--support.syntax--class {
  color: #c18401;
}
.syntax--support.syntax--type {
  color: #0184bc;
}
.syntax--support.syntax--function {
  color: #0184bc;
}
.syntax--support.syntax--function.syntax--any-method {
  color: #4078f2;
}
.syntax--entity.syntax--name.syntax--function {
  color: #4078f2;
}
.syntax--entity.syntax--name.syntax--class,
.syntax--entity.syntax--name.syntax--type.syntax--class {
  color: #c18401;
}
.syntax--entity.syntax--name.syntax--section {
  color: #4078f2;
}
.syntax--entity.syntax--name.syntax--tag {
  color: #e45649;
}
.syntax--entity.syntax--other.syntax--attribute-name {
  color: #986801;
}
.syntax--entity.syntax--other.syntax--attribute-name.syntax--id {
  color: #4078f2;
}
.syntax--meta.syntax--class {
  color: #c18401;
}
.syntax--meta.syntax--class.syntax--body {
  color: #383a42;
}
.syntax--meta.syntax--method-call,
.syntax--meta.syntax--method {
  color: #383a42;
}
.syntax--meta.syntax--definition.syntax--variable {
  color: #e45649;
}
.syntax--meta.syntax--link {
  color: #986801;
}
.syntax--meta.syntax--require {
  color: #4078f2;
}
.syntax--meta.syntax--selector {
  color: #a626a4;
}
.syntax--meta.syntax--separator {
  background-color: #373b41;
  color: #383a42;
}
.syntax--meta.syntax--tag {
  color: #383a42;
}
.syntax--underline {
  text-decoration: underline;
}
.syntax--none {
  color: #383a42;
}
.syntax--invalid.syntax--deprecated {
  color: #000000 !important;
  background-color: #f2a60d !important;
}
.syntax--invalid.syntax--illegal {
  color: white !important;
  background-color: #ff1414 !important;
}
.syntax--markup.syntax--bold {
  color: #986801;
  font-weight: bold;
}
.syntax--markup.syntax--changed {
  color: #a626a4;
}
.syntax--markup.syntax--deleted {
  color: #e45649;
}
.syntax--markup.syntax--italic {
  color: #a626a4;
  font-style: italic;
}
.syntax--markup.syntax--heading {
  color: #e45649;
}
.syntax--markup.syntax--heading .syntax--punctuation.syntax--definition.syntax--heading {
  color: #4078f2;
}
.syntax--markup.syntax--link {
  color: #0184bc;
}
.syntax--markup.syntax--inserted {
  color: #50a14f;
}
.syntax--markup.syntax--quote {
  color: #986801;
}
.syntax--markup.syntax--raw {
  color: #50a14f;
}
.syntax--source.syntax--c .syntax--keyword.syntax--operator {
  color: #a626a4;
}
.syntax--source.syntax--cpp .syntax--keyword.syntax--operator {
  color: #a626a4;
}
.syntax--source.syntax--cs .syntax--keyword.syntax--operator {
  color: #a626a4;
}
.syntax--source.syntax--css .syntax--property-name,
.syntax--source.syntax--css .syntax--property-value {
  color: #696c77;
}
.syntax--source.syntax--css .syntax--property-name.syntax--support,
.syntax--source.syntax--css .syntax--property-value.syntax--support {
  color: #383a42;
}
.syntax--source.syntax--elixir .syntax--source.syntax--embedded.syntax--source {
  color: #383a42;
}
.syntax--source.syntax--elixir .syntax--constant.syntax--language,
.syntax--source.syntax--elixir .syntax--constant.syntax--numeric,
.syntax--source.syntax--elixir .syntax--constant.syntax--definition {
  color: #4078f2;
}
.syntax--source.syntax--elixir .syntax--variable.syntax--definition,
.syntax--source.syntax--elixir .syntax--variable.syntax--anonymous {
  color: #a626a4;
}
.syntax--source.syntax--elixir .syntax--quoted {
  color: #50a14f;
}
.syntax--source.syntax--elixir .syntax--keyword.syntax--special-method,
.syntax--source.syntax--elixir .syntax--embedded.syntax--section,
.syntax--source.syntax--elixir .syntax--embedded.syntax--source.syntax--empty {
  color: #e45649;
}
.syntax--source.syntax--elixir .syntax--readwrite.syntax--module .syntax--punctuation {
  color: #e45649;
}
.syntax--source.syntax--elixir .syntax--regexp.syntax--section,
.syntax--source.syntax--elixir .syntax--regexp.syntax--string {
  color: #ca1243;
}
.syntax--source.syntax--elixir .syntax--separator,
.syntax--source.syntax--elixir .syntax--keyword.syntax--operator {
  color: #986801;
}
.syntax--source.syntax--elixir .syntax--variable.syntax--constant {
  color: #c18401;
}
.syntax--source.syntax--elixir .syntax--array,
.syntax--source.syntax--elixir .syntax--scope,
.syntax--source.syntax--elixir .syntax--section {
  color: #696c77;
}
.syntax--source.syntax--gfm .syntax--markup {
  -webkit-font-smoothing: auto;
}
.syntax--source.syntax--gfm .syntax--link .syntax--entity {
  color: #4078f2;
}
.syntax--source.syntax--go .syntax--storage.syntax--type.syntax--string {
  color: #a626a4;
}
.syntax--source.syntax--ini .syntax--keyword.syntax--other.syntax--definition.syntax--ini {
  color: #e45649;
}
.syntax--source.syntax--java .syntax--storage.syntax--modifier.syntax--import {
  color: #c18401;
}
.syntax--source.syntax--java .syntax--storage.syntax--type {
  color: #c18401;
}
.syntax--source.syntax--java .syntax--keyword.syntax--operator.syntax--instanceof {
  color: #a626a4;
}
.syntax--source.syntax--java-properties .syntax--meta.syntax--key-pair {
  color: #e45649;
}
.syntax--source.syntax--java-properties .syntax--meta.syntax--key-pair > .syntax--punctuation {
  color: #383a42;
}
.syntax--source.syntax--js .syntax--keyword.syntax--operator {
  color: #0184bc;
}
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--delete,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--in,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--of,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--instanceof,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--new,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--typeof,
.syntax--source.syntax--js .syntax--keyword.syntax--operator.syntax--void {
  color: #a626a4;
}
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--dictionary.syntax--json > .syntax--string.syntax--quoted.syntax--json {
  color: #e45649;
}
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--dictionary.syntax--json > .syntax--string.syntax--quoted.syntax--json > .syntax--punctuation.syntax--string {
  color: #e45649;
}
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--dictionary.syntax--json > .syntax--value.syntax--json > .syntax--string.syntax--quoted.syntax--json,
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--array.syntax--json > .syntax--value.syntax--json > .syntax--string.syntax--quoted.syntax--json,
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--dictionary.syntax--json > .syntax--value.syntax--json > .syntax--string.syntax--quoted.syntax--json > .syntax--punctuation,
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--array.syntax--json > .syntax--value.syntax--json > .syntax--string.syntax--quoted.syntax--json > .syntax--punctuation {
  color: #50a14f;
}
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--dictionary.syntax--json > .syntax--constant.syntax--language.syntax--json,
.syntax--source.syntax--json .syntax--meta.syntax--structure.syntax--array.syntax--json > .syntax--constant.syntax--language.syntax--json {
  color: #0184bc;
}
.syntax--source.syntax--ruby .syntax--constant.syntax--other.syntax--symbol > .syntax--punctuation {
  color: inherit;
}
.syntax--source.syntax--python .syntax--keyword.syntax--operator.syntax--logical.syntax--python {
  color: #a626a4;
}
.syntax--source.syntax--python .syntax--variable.syntax--parameter {
  color: #986801;
}

pre.editor-colors { overflow: auto; }</style>
  </head>
  <body class="markdown-preview-plus-view">
    <h1>Background</h1>
<p><a href="https://www.tensorflow.org">Tensorflow</a> is a machine-learning framework developed by Google and publicly released in 2015. Its latest version at the time of this writing is 1.7, but we have mainly used version 1.4.</p>
<p>Despite being primarily a machine learning framework, TensorFlow has a general purpose computational core that can perform various operations on tensors (i.e., arbitrary multi-dimensional arrays). Here, our goal is to test the suitability of TensorFlow for solving coupled systems of ordinary differential equations (ODE) that arise in the numerical modeling of cardiac electrophysiology systems. However, the lessons learned in developing <strong>fib_tf</strong> are not limited to cardiac simulation and apply to a broader range of ODE solving problems.</p>
<p>The main power of TensorFlow that distinguishes it from many other computational frameworks is its ability to run the model graphs on heterogeneous hardwares, including CPU, Graphic Processing Units (GPU), Field Programmable Gated Arrays (FPGA) or even Google developed Tensor Processing Units (TPU).</p>
<h1>TOC</h1>
<ul>
<li><a href="#introduction-to-fib-tf">Introduction to <strong>fib_tf</strong></a></li>
<li><a href="#4v-cardiac-model"><em>4v</em> Cardiac Model</a></li>
<li><a href="#a-simple-4v-solver">A Simple 4v Solver</a></li>
<li><a href="#the-root-cause-of-slowness">The Root Cause of Slowness</a></li>
<li><a href="#just-in-time-jit-compilation-to-rescue-">Just-In-Time (JIT) Compilation to Rescue!</a></li>
<li><a href="#other-optimization-tricks">Other Optimization Tricks</a>
<ul>
<li><a href="#laplacian">Laplacian</a></li>
<li><a href="#graph-unrolling">Graph Unrolling</a></li>
</ul>
</li>
<li><a href="#the-beeler-reuter-ionic-model">The Beeler-Reuter Ionic Model</a>
<ul>
<li><a href="the-rush-larsen-method">The Rush-Larsen Method</a></li>
<li><a href="#using-the-chebyshev-polynomials">Using the Chebyshev Polynomials</a></li>
<li><a href="#multi-rate-integration">Multi-rate Integration</a></li>
</ul>
</li>
<li><a href="#phase-field">Phase Field</a></li>
<li><a href="#conclusions">Conclusions</a></li>
</ul>
<h1><a name="introduction-to-fib-tf"></a> Introduction to <strong>fib_tf</strong></h1>
<p><strong>fib_tf</strong> is a Python framework developed on the top of TensorFlow for 2D cardiac electrophysiology simulation using explicit Euler method.</p>
<p><strong>fib_tf</strong> is designed to run on a GPU (it can also run on CPU, but slower). Cardiac electrophysiology models are particularly suitable for running on massively parallel architectures such as GPU, as the coupling between ODEs is through Laplacian, which takes only a small fraction of the total computational cost.</p>
<p>Our goal is to optimize the <strong>fib_tf</strong> code to make its running time as close as possible to a hand-optimized CUDA C++ code running the same model.</p>
<p>In this document, we first describe a straightforward translation of a cardiac model into TensorFlow. We then explain various optimization tricks needed to make <strong>fib_tf</strong> performance acceptable.</p>
<p>There are more than 100 different ionic models that describe cardiac electrical activity in various degrees of detail (see this page for an overview of the available models). Most are based on the classic Hodgkin-Huxley model and define the time-evolution of different transmembrane and sarcoplasmic ionic currents in the form of nonlinear first-order ODEs. The state vector for these models includes the transmembrane voltage, gating variables, and ionic concentrations. By nature, these models have to deal with different time scales and are therefore classified as <em>stiff</em>. Commonly, these models are solved using the explicit Euler method, usually with a closed form for the integration of the gating variables (<a href="the-rush-larsen-method">The Rush-Larsen Method</a>). Other techniques used are the implicit Euler and adaptive time-step methods. Higher order integration methods such as Runge-Kutta and linear multi-step methods cannot overcome the stiffness and are not particularly helpful.</p>
<p>To study wave progression, 1D (cable), 2D and 3D cardiac models are constructed by coupling up to millions of ODEs together. Until a few years ago, simulating one second of cardiac activity in a detailed 3D model with realistic ionic currents could easily take upwards of an hour. With the advent of massively parallel architectures (especially GPUs), this task can now be done with near real-time efficiency.</p>
<h1><a name="4v-cardiac-model"></a> <em>4v</em> Cardiac Model</h1>
<p>Let’s start by writing a simple 2D solver for the <a href="http://www.heartrhythmjournal.com/article/S1547-5271(07)00874-0/fulltext">Cherry-Ehrlich-Nattel-Fenton</a> 4-variable atrial model (<em>4v</em> from here on). With only four state variables, this model provides a good entry point without being trivial.</p>
<p>The foundation of most cardiac electrophysiology simulations is the standard mono-domain reaction-diffusion equation,</p>
<span class="math"><script type="math/tex; mode=display">  \partial V / \partial t = \nabla (D  \nabla V) - \frac {I_{ion}} {C_m},
</script></span>
<p>where the scalar field <span class="math"><script type="math/tex">V</script></span> is the transmembrane potential, <span class="math"><script type="math/tex">D</script></span> is the diffusion tensor, <span class="math"><script type="math/tex">I_{ion}</script></span> is the sum of all ionic currents, and <span class="math"><script type="math/tex">C_m</script></span> is the membrane capacitance (<span class="math"><script type="math/tex">C_m</script></span> is usually set to 1 μF/cm). In general, the diffusion part, <span class="math"><script type="math/tex">\nabla (D  \nabla V)</script></span>, denotes the coupling between neighboring cells and is modeled as a partial differential equation (PDE); whereas, the reaction part, <span class="math"><script type="math/tex">I_{ion}/C_m</script></span>, is solved as a system of ODEs.</p>
<p>For the sake of simplicity, we assume a uniform isotropic medium and solve the PDE part of the problem using the finite-difference methodology (we will add a <a href="#phase-field"><em>phase field</em></a> later on to accommodate non-rectangular geometries). Therefore, tensor <span class="math"><script type="math/tex">D</script></span> is reduced to a scalar <span class="math"><script type="math/tex">g</script></span> that quantifies the global diffusion coefficient. We have</p>
<span class="math"><script type="math/tex; mode=display">  \partial V / \partial t = g\,\nabla^2{V} - \frac {I_{ion}} {C_m}.
</script></span>
<p>The <em>4v</em> model has four state variables: <span class="math"><script type="math/tex">u</script></span>, <span class="math"><script type="math/tex">v</script></span>, <span class="math"><script type="math/tex">w</script></span>, and <span class="math"><script type="math/tex">s</script></span>. The transmembrane voltage is represented by <span class="math"><script type="math/tex">u</script></span>. The other three variables represent gates with different time constants. All four variables range from 0 to 1. The initial condition is <span class="math"><script type="math/tex">(u, v, w, s) = (0, 1, 1, 0)</script></span>, corresponding to resting cells.</p>
<p>Based on the explicit Euler integration rule, we have</p>
<span class="math"><script type="math/tex; mode=display">    v(t+\Delta{t}) = v(t) + \Delta{t}\,dv/dt,
</script></span>
<p>where we have made the dependency on <span class="math"><script type="math/tex">t</script></span> explicit. Similarly,</p>
<span class="math"><script type="math/tex; mode=display">    w(t+\Delta{t}) = w(t) + \Delta{t}\,dw/dt,
</script></span>
<p>and,</p>
<span class="math"><script type="math/tex; mode=display">    s(t+\Delta{t}) = s(t) + \Delta{t}\,ds/dt.
</script></span>
<p>The time integration formula for <span class="math"><script type="math/tex">u</script></span> has an additional term related to diffusion,</p>
<span class="math"><script type="math/tex; mode=display">    u(t+\Delta{t}) = u(t) + \Delta{t}\,du/dt + g\,\Delta{t}\,\nabla^2{u}.
</script></span>
<p>We need to calculate the time derivatives of the state variables at each time point. First, we update the dynamic time constants,</p>
<span class="math"><script type="math/tex; mode=display">  \tau_v^- =
  \begin{cases}
    \tau_{v2}^- & \quad \text{if } u \geq u_v \\
    \tau_{v1}^- & \quad \text{if } u < u_v
  \end{cases},
</script></span>
<p>and,</p>
<span class="math"><script type="math/tex; mode=display">  r_s =
  \begin{cases}
    r_s^+ & \quad \text{if } u \geq u_c \\
    r_s^- & \quad \text{if } u < u_c
  \end{cases}.
</script></span>
<p>Note that you can find the value of the model parameters, such as <span class="math"><script type="math/tex">\tau_{v1}^-</script></span> and <span class="math"><script type="math/tex">u_v</script></span>, in <strong>fenton.differentiate</strong> (file <strong><a href="http://fenton.py">fenton.py</a></strong>). Next, the instantaneous currents are calculated</p>
<span class="math"><script type="math/tex; mode=display">  I_{fi} =
  \begin{cases}
    -v(u-u_c)(1-u) / \tau_d & \quad \text{if } u \geq u_c \\
    0 & \quad \text{if } u < u_v
  \end{cases},
</script></span>
<span class="math"><script type="math/tex; mode=display">  I_{si} = -ws / \tau_{si},
</script></span>
<span class="math"><script type="math/tex; mode=display">  I_{so}' =
  \begin{cases}
    \tau_a & \quad \text{if } u \geq u_{so} \\
    u/\tau_0 & \quad \text{if } u < u_{so}
  \end{cases}
</script></span>
<p>and,</p>
<span class="math"><script type="math/tex; mode=display">  I_{so} = I_{so}' + 0.5 (a_{so} - \tau_a) \left(1 + \tanh(\frac{u-b_{so}}{c_{so}}) \right).
</script></span>
<p>Finally, we obtain the time derivative of the state variables,</p>
<span class="math"><script type="math/tex; mode=display">  du/dt = -(I_{fi} + I_{si} + I_{so}),
</script></span>
<span class="math"><script type="math/tex; mode=display">  dv/dt =
  \begin{cases}
    (1-v) / \tau_v^+ & \quad \text{if } u < u_c \\
    -v / \tau_v^- & \quad \text{if } u \geq u_c
  \end{cases},
</script></span>
<span class="math"><script type="math/tex; mode=display">  dw/dt =
  \begin{cases}
    (1-w) / \tau_w^+ & \quad \text{if } u < u_c \\
    -w / \tau_w^- & \quad \text{if } u \geq u_c
  \end{cases},
</script></span>
<p>and,</p>
<span class="math"><script type="math/tex; mode=display">  ds/dt = r_s \left(\frac{1 + \tanh(k(u-u_{c,si}))}{2} -s\right).
</script></span>
<h1><a name="a-simple-4v-solver"></a> A Simple 4v Solver</h1>
<p>The TensorFlow website has an <a href="https://www.tensorflow.org/tutorials/pdes">example</a> of solving a simple PDE. This example has served as the starting point for <strong>fib_tf</strong>; albeit, in the end, only a tiny fraction of its code remained in the final code base.</p>
<p>In this section, we present a straightforward translation of the <em>4v</em> model into the TensorFlow code by modifying the above example. You can find the source code in <strong>fenton_simple.py</strong>. As we will see, the resulting code is not very efficient. Afterward, we will discuss various modifications to make it faster.</p>
<p>In a typical TensorFlow application, we first define a TensorFlow <strong>dataflow graph</strong>. A dataflow graph is a directed acyclic graph, where nodes correspond to tensors (general multi-dimensional arrays) or operations on tensors, and links denote data movement between the nodes. Such a graph can be executed once or multiple times.</p>
<p><strong>fenton_simple.py</strong> begins with few utility functions. <strong>laplace()</strong> and its helper functions (<strong>make_kernel()</strong> and <strong>simple_conv()</strong>) are copied verbatim from the  <a href="https://www.tensorflow.org/tutorials/pdes">example</a>. <strong>enforce_boundary()</strong> ensures a no-flux (Neumann) boundary condition.</p>
<p>The TensorFlow example also defines a utility function <strong>DisplayArray()</strong> to visualize the results of simulation. This function only works in a Jupyter notebook environment. I prefer a more general visualization routine that also works from ipython and command line. Therefore, instead of <strong>DisplayArray()</strong>, we import <strong>Screen</strong> from <strong><a href="http://screen.py">screen.py</a></strong> that plots on an SDL2 window.</p>
<p>The bulk of the code is contained in the class <strong>Fenton4vSimple</strong>. The model dataflow graph is defined in <strong>Fenton4vSimple.define()</strong>, where we introduce four numpy arrays to represent the shape and initial values of the four state variables:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>u_init</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>np</span><span>.</span><span>full</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>height</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>width</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span><span>, </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>min_v</span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>dtype</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span>np</span><span>.</span><span>float32</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>v_init</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>np</span><span>.</span><span>full</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>height</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>width</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>1.0</span></span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>dtype</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span>np</span><span>.</span><span>float32</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>w_init</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>np</span><span>.</span><span>full</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>height</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>width</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>1.0</span></span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>dtype</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span>np</span><span>.</span><span>float32</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>s_init</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>np</span><span>.</span><span>full</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>height</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>width</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>0.0</span></span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>dtype</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span>np</span><span>.</span><span>float32</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<p>For the <em>4v</em> model, <code>min_v</code> is 0 and <code>max_v</code> is 1, representing the range of <span class="math"><script type="math/tex">u</script></span>. Then, we define four corresponding TensorFlow variables and link them to the numpy arrays:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>U</span><span>  </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>Variable</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>u_init</span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span class="syntax--string syntax--quoted syntax--single syntax--single-line syntax--python"><span class="syntax--punctuation syntax--definition syntax--string syntax--begin syntax--python"><span>'</span></span><span>U</span><span class="syntax--punctuation syntax--definition syntax--string syntax--end syntax--python"><span>'</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>V</span><span>  </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>Variable</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>v_init</span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span class="syntax--string syntax--quoted syntax--single syntax--single-line syntax--python"><span class="syntax--punctuation syntax--definition syntax--string syntax--begin syntax--python"><span>'</span></span><span>V</span><span class="syntax--punctuation syntax--definition syntax--string syntax--end syntax--python"><span>'</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>W</span><span>  </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>Variable</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>w_init</span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span class="syntax--string syntax--quoted syntax--single syntax--single-line syntax--python"><span class="syntax--punctuation syntax--definition syntax--string syntax--begin syntax--python"><span>'</span></span><span>W</span><span class="syntax--punctuation syntax--definition syntax--string syntax--end syntax--python"><span>'</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>S</span><span>  </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>Variable</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>s_init</span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span class="syntax--string syntax--quoted syntax--single syntax--single-line syntax--python"><span class="syntax--punctuation syntax--definition syntax--string syntax--begin syntax--python"><span>'</span></span><span>S</span><span class="syntax--punctuation syntax--definition syntax--string syntax--end syntax--python"><span>'</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<p>The dataflow graph to calculate the new values of the state variables after one time step of the explicit Euler method is generated by calling <strong>Fenton4vSimple.solve()</strong> (which in turns calls <strong>Fenton4vSimple.differentiate()</strong>) as:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>state</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>U</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>V</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>W</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>S</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span></span>
<span class="syntax--source syntax--python"><span>U1</span><span>, </span><span>V1</span><span>, </span><span>W1</span><span>, </span><span>S1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>solve</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>state</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<p>Finally, we need to copy back the latest values of the state variables. As mentioned above, dataflow graphs are usually acyclic. One exception to this rule is <strong>tf.assign</strong> operation that allows such copies. We have:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>_ode_op</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>group</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>    </span><span class="syntax--meta syntax--function-call syntax--python"><span>U</span><span>.</span><span>assign</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>U1</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>,</span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>    </span><span class="syntax--meta syntax--function-call syntax--python"><span>V</span><span>.</span><span>assign</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>V1</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>,</span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>    </span><span class="syntax--meta syntax--function-call syntax--python"><span>W</span><span>.</span><span>assign</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>W1</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>,</span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>    </span><span class="syntax--meta syntax--function-call syntax--python"><span>S</span><span>.</span><span>assign</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>S1</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>    </span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<p>To run a graph, it should be connected to a <strong>tf.Session</strong> that provides the context of execution. This is done in <strong>Fenton4vSimple.run()</strong>. It creates a session and initializes the graph, runs the graph for the desired number of steps and send the transmembrane voltage array to the screen every 1 ms for visualization.</p>
<p>We can run the model as</p>
<pre class="editor-colors lang-text"><span class="syntax--text syntax--plain"><span class="syntax--meta syntax--paragraph syntax--text"><span>python3 fenton_simple.py</span></span></span>
</pre>
<p>It creates a spiral wave by applying a cross-stimulation protocol (the S1-S2 protocol). At the end of the run, the result looks like this</p>
<p><img src="https://siravan.github.io/fib_tf/4v.png" alt=""></p>
<p>On my desktop computer (1.7 GHz quad-code running Ubuntu 14.04 with an NVidia GTX-1080 GPU), <strong>fenton_simple.py</strong> takes ~11 seconds to run one second of simulation over a 512 x 512 medium (assuming no real-time screen update). This is not good! A hand-optimized CUDA code runs the same thing in less than a second. In the following sections, we describe optimization tricks that improve the timing by a factor of 4.</p>
<h1><a name="the-root-cause-of-slowness"></a> The Root Cause of Slowness</h1>
<p>Let’s first see if we can find the cause of the sub-optimal performance of the simple model.</p>
<p>TensorFlow has a powerful <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/profiler/README.md">profiler</a>. We profile one time step in <strong>Fenton4vSimple.run()</strong> and save the results as <em>timeline_simple.json</em>, which can be visualized in chrome browsers by typing <em>chrome://trace</em> in the address bar and load the file. The result is</p>
<p><img src="https://siravan.github.io/fib_tf/timeline_simple.png" alt=""></p>
<p>Based on the horizontal time bar on the top of the figure, one time step takes a little over <span class="math"><script type="math/tex">1,200\,\mu\text{s}</script></span>. Since <span class="math"><script type="math/tex">\Delta{t} = 0.1\,\text{ms}</script></span>, one second of simulation requires 10000 iterations or ~12 sec.</p>
<p>This profile reveals the main problem. It is the presence of numerous CUDA kernel launches (each green or purple block signifies a CUDA kernel). The way TensorFlow works on GPU is to assign each operation to a CUDA kernel. This works well for machine learning, where each operation does lots of computations. But for solving systems of ODEs, most of the calculations is element-wise light-weight operations. In the baseline TensorFlow, kernels correspond to basic operations like <em>Add</em>, <em>Sub</em>, <em>Mul</em>, and <em>Conv</em>. Each kernel launch imposes a timing overhead (the white gaps between the blocks). Even worse is the fact that each kernel needs to read its inputs from and write its outputs to the global GPU memory. Considering that the global memory is the primary bottleneck of the GPU applications, all these reading and writing intermediate results severely degrade the performance.</p>
<p>Fortunately, the TensorFlow developers have recognized this problem and have devised a clever solution, which is discussed in the next section.</p>
<h1><a name="just-in-time-jit-compilation-to-rescue-"></a> Just-In-Time (JIT) Compilation to Rescue!</h1>
<p>TensorFlow has the very exciting capability of using <a href="https://www.tensorflow.org/performance/xla/jit">JIT compilation</a> to combine multiple atomic CUDA kernels into one large kernel. JIT compilation mitigates the performance penalty of having many smaller kernels. However, it is still not available in the stock versions of TensorFlow (at least not in version 1.7). To enable it, you need to <a href="https://www.tensorflow.org/install/install_sources">compile</a> TensorFlow from source.</p>
<p><strong>fenton_jit.py</strong> is a modified version of <strong>fenton_simple.py</strong>. The main change is in <strong>fenton_simple.solve()</strong>, where the Euler integration steps are moved inside a <em>jit_scope</em>.</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>scope</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>contrib</span><span>.</span><span>compiler</span><span>.</span><span>jit</span><span>.</span><span>experimental_jit_scope</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--keyword syntax--control syntax--statement syntax--python"><span>with</span></span><span> </span><span>scope</span><span>:</span></span>
<span class="syntax--source syntax--python"><span>    </span><span>dU</span><span>, </span><span>dV</span><span>, </span><span>dW</span><span>, </span><span>dS</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>differentiate</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>U</span><span>, </span><span>V</span><span>, </span><span>W</span><span>, </span><span>S</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>    </span><span>U1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>U0</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>dt</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span>dU</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>diff</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>dt</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>laplace</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>U0</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>    </span><span>V1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>V</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>dt</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span>dV</span></span>
<span class="syntax--source syntax--python"><span>    </span><span>W1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>W</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>dt</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span>dW</span></span>
<span class="syntax--source syntax--python"><span>    </span><span>S1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>S</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>dt</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span>dS</span></span>
</pre>
<p>Just with this one single change, the model runs more than twice faster (~4.5 seconds per second of simulation). Now, the profile becomes</p>
<p><img src="https://siravan.github.io/fib_tf/timeline_jit.png" alt="timeline_jit.json"></p>
<p>One time step takes a little over <span class="math"><script type="math/tex">500\,\mu\text{s}</script></span>. Also note there are only few blocks. The blue blocks are the fused kernels generated by the JIT compiler and contain most of the logic of the program.</p>
<h1><a name="other-optimization-tricks"></a> Other Optimization Tricks</h1>
<p>JIT compilation is the main, but not the sole, optimization trick to improve the performance. In this section, we describe few other improvements that together raise the performance of the <em>4v</em> solver by another factor of 1.5-2.</p>
<p>The final version of the <em>4v</em> solver is <strong><a href="http://fenton.py">fenton.py</a></strong>. Note that we have re-factored the code into two files. The model-independent codes are collected in a <em>virtual</em> base class <strong>Ionic</strong> (in <strong><a href="http://ionic.py">ionic.py</a></strong>). The model-specific code is structured as a class <strong>Fenton4v</strong> (defined in <strong><a href="http://fenton.py">fenton.py</a></strong>) that extends <strong>Ionic</strong>. This version of the <em>4v</em> solver takes 2.8 seconds per second of simulation. For comparison, it takes 50 seconds per second of simulation while running on CPU.</p>
<h2><a name="laplacian"></a> Laplacian</h2>
<p>Up to this point, we have used the function <strong>laplace()</strong> copied from the PDE <a href="https://www.tensorflow.org/tutorials/pdes">example</a> of the TensorFlow website. The actual calculation of the Laplacian is done by calling <strong>tf.nn.depthwise_conv2d()</strong>. However, this function is designed with convolutional neural networks in mind and is not the best fit for our application. Instead, a direct calculation of Laplacian with hard-coded coefficients, as is done in <strong>Ionic.laplace()</strong>, improves the performance:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>l</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>(</span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>,:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span></span>
<span class="syntax--source syntax--python"><span>     </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>0.5</span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span>(</span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>,:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:,:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span>:</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span>)</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span></span>
<span class="syntax--source syntax--python"><span>     </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>6</span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>X</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>,</span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span><span>:</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span>)</span></span>
</pre>
<p>Here X stands for the transmembrane potential. Note that <strong>Ionic.laplace()</strong> also deals with phase fields, as discussed below.</p>
<h2><a name="graph-unrolling"></a> Graph Unrolling</h2>
<p>Graph unrolling is a special case of <a href="https://en.wikipedia.org/wiki/Loop_unrolling">loop unrolling</a>. A simple example of loop unrolling in C is to replace the following <code>for</code> loop</p>
<pre class="editor-colors lang-C"><span class="syntax--source syntax--c"><span class="syntax--keyword syntax--control syntax--c"><span>for</span></span><span class="syntax--punctuation syntax--section syntax--parens syntax--begin syntax--bracket syntax--round syntax--c"><span>(</span></span><span>i </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--c"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--c"><span>0</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span><span> i </span><span class="syntax--keyword syntax--operator syntax--comparison syntax--c"><span>&lt;</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--c"><span>1000</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span><span> i</span><span class="syntax--keyword syntax--operator syntax--increment syntax--c"><span>++</span></span><span class="syntax--punctuation syntax--section syntax--parens syntax--end syntax--bracket syntax--round syntax--c"><span>)</span></span><span> </span><span class="syntax--meta syntax--block syntax--c"><span class="syntax--punctuation syntax--section syntax--block syntax--begin syntax--bracket syntax--curly syntax--c"><span>{</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span>    sum </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span> x</span><span class="syntax--punctuation syntax--definition syntax--begin syntax--bracket syntax--square syntax--c"><span>[</span></span><span>i</span><span class="syntax--punctuation syntax--definition syntax--end syntax--bracket syntax--square syntax--c"><span>]</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span class="syntax--punctuation syntax--section syntax--block syntax--end syntax--bracket syntax--curly syntax--c"><span>}</span></span></span></span>
</pre>
<p>with a code like this</p>
<pre class="editor-colors lang-C"><span class="syntax--source syntax--c"><span class="syntax--keyword syntax--control syntax--c"><span>for</span></span><span class="syntax--punctuation syntax--section syntax--parens syntax--begin syntax--bracket syntax--round syntax--c"><span>(</span></span><span>i </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--c"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--c"><span>0</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span><span> i </span><span class="syntax--keyword syntax--operator syntax--comparison syntax--c"><span>&lt;</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--c"><span>1000</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span><span> i</span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span class="syntax--constant syntax--numeric syntax--c"><span>4</span></span><span class="syntax--punctuation syntax--section syntax--parens syntax--end syntax--bracket syntax--round syntax--c"><span>)</span></span><span> </span><span class="syntax--meta syntax--block syntax--c"><span class="syntax--punctuation syntax--section syntax--block syntax--begin syntax--bracket syntax--curly syntax--c"><span>{</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span>    sum </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span> x</span><span class="syntax--punctuation syntax--definition syntax--begin syntax--bracket syntax--square syntax--c"><span>[</span></span><span>i</span><span class="syntax--punctuation syntax--definition syntax--end syntax--bracket syntax--square syntax--c"><span>]</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span>    sum </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span> x</span><span class="syntax--punctuation syntax--definition syntax--begin syntax--bracket syntax--square syntax--c"><span>[</span></span><span>i</span><span class="syntax--keyword syntax--operator syntax--c"><span>+</span></span><span class="syntax--constant syntax--numeric syntax--c"><span>1</span></span><span class="syntax--punctuation syntax--definition syntax--end syntax--bracket syntax--square syntax--c"><span>]</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span>    sum </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span> x</span><span class="syntax--punctuation syntax--definition syntax--begin syntax--bracket syntax--square syntax--c"><span>[</span></span><span>i</span><span class="syntax--keyword syntax--operator syntax--c"><span>+</span></span><span class="syntax--constant syntax--numeric syntax--c"><span>2</span></span><span class="syntax--punctuation syntax--definition syntax--end syntax--bracket syntax--square syntax--c"><span>]</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span>    sum </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--compound syntax--c"><span>+=</span></span><span> x</span><span class="syntax--punctuation syntax--definition syntax--begin syntax--bracket syntax--square syntax--c"><span>[</span></span><span>i</span><span class="syntax--keyword syntax--operator syntax--c"><span>+</span></span><span class="syntax--constant syntax--numeric syntax--c"><span>3</span></span><span class="syntax--punctuation syntax--definition syntax--end syntax--bracket syntax--square syntax--c"><span>]</span></span><span class="syntax--punctuation syntax--terminator syntax--statement syntax--c"><span>;</span></span><span>    </span></span></span>
<span class="syntax--source syntax--c"><span class="syntax--meta syntax--block syntax--c"><span class="syntax--punctuation syntax--section syntax--block syntax--end syntax--bracket syntax--curly syntax--c"><span>}</span></span></span></span>
</pre>
<p>The goal is to increase the speed by reducing the number of times the for loop logic is checked and applied (Disclaimer: don’t use this example! Modern compilers are much better in generating optimized code than most programmers).</p>
<p>Graph unrolling is the application of this idea to dataflow graphs. In our <em>4v</em> solvers, each time step is 0.1 ms, but the screen is updated every 1 ms. We can combine 10 time steps into one, as is done in <strong>fenton.define()</strong>:</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>states</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span class="syntax--meta syntax--structure syntax--list syntax--python"><span class="syntax--punctuation syntax--definition syntax--list syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>U</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>V</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>W</span></span><span class="syntax--punctuation syntax--separator syntax--list syntax--python"><span>,</span></span><span> </span><span class="syntax--meta syntax--structure syntax--list syntax--item syntax--python"><span>S</span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--list syntax--end syntax--python"><span>]</span></span></span></span>
<span class="syntax--source syntax--python"><span class="syntax--keyword syntax--control syntax--repeat syntax--python"><span>for</span></span><span> </span><span>i</span><span> </span><span class="syntax--keyword syntax--operator syntax--logical syntax--python"><span>in</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--support syntax--function syntax--builtin syntax--python"><span>range</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>10</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>:</span></span>
<span class="syntax--source syntax--python"><span>    </span><span class="syntax--meta syntax--function-call syntax--python"><span>states</span><span>.</span><span>append</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>solve</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--meta syntax--item-access syntax--python"><span>states</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
<span class="syntax--source syntax--python"><span>U1</span><span>, </span><span>V1</span><span>, </span><span>W1</span><span>, </span><span>S1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>states</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span></span>
</pre>
<p>Currently, this trick improves the performance by allowing the TensorFlow optimizer to prune the model graph and to remove some operations. For example, the <strong>tf.pad</strong> operation in <strong>enforce_boundary()</strong> is removed from between the fused kernels. What it does not yet do is to generate a large fused kernel by fusing all the individual kernels together. However, I’m not aware of any theoretical reason why this cannot be done. Hopefully, future versions of the TensorFlow JIT compiler become smart enough to handles this situation.</p>
<p>Another benefit of graph unrolling is to allow for multi-rate integration (see <a href="#multi-rate-integration">below</a>).</p>
<h1><a name="the-beeler-reuter-ionic-model"></a> The Beeler-Reuter Ionic Model</h1>
<p>We have chosen the <a href="https://www.ncbi.nlm.nih.gov/pubmed/?term=874889">Beeler-Reuter ventricular myocyte model</a> as our second example. The model can be found in <strong>BeelerReuter.solve()</strong> in the file <strong><a href="http://br.py">br.py</a></strong>.</p>
<p>The Beeler-Reuter model has eight variables: the transmembrane potential (<span class="math"><script type="math/tex">v</script></span>), sodium-channel activation and inactivation gates (<span class="math"><script type="math/tex">m</script></span> and <span class="math"><script type="math/tex">h</script></span>, similar to the Hodgkin-Huxley model), with an additional slow inactivation gate (<span class="math"><script type="math/tex">j</script></span>), calcium-channel activation and deactivations gates (<span class="math"><script type="math/tex">d</script></span> and <span class="math"><script type="math/tex">f</script></span>), a time-dependent outward potassium current gate (<span class="math"><script type="math/tex">x_1</script></span>), and intracellular calcium concentration (<span class="math"><script type="math/tex">c</script></span>). There are four currents: a sodium current (<span class="math"><script type="math/tex">i_{Na}</script></span>), a calcium current (<span class="math"><script type="math/tex">i_{s}</script></span>), and two potassium currents, one time-dependent (<span class="math"><script type="math/tex">i_{x_1}</script></span>) and one time-independent (<span class="math"><script type="math/tex">i_{K_1}</script></span>).</p>
<p>There are eight equations for the time derivatives of the state variables. For <span class="math"><script type="math/tex">v</script></span>, it is simply the reaction-diffusion equations,</p>
<span class="math"><script type="math/tex; mode=display">  \partial v / \partial t = \nabla (D  \nabla v) - \frac {i_{Na} + i_{s} + i_{x_1} + i_{K_1}} {C_m}.
</script></span>
<p>For <span class="math"><script type="math/tex">c</script></span>, it is</p>
<span class="math"><script type="math/tex; mode=display">dc / dt = -10^{-7} i_s + 0.07 (10^{-7} - c)  .
</script></span>
<p>Each of the six gating variables follows a classic Hodgkin-Huxley dynamics. Let <span class="math"><script type="math/tex">x</script></span> be one of <span class="math"><script type="math/tex">m</script></span>, <span class="math"><script type="math/tex">h</script></span>, <span class="math"><script type="math/tex">j</script></span>, <span class="math"><script type="math/tex">d</script></span>, <span class="math"><script type="math/tex">f</script></span>, or <span class="math"><script type="math/tex">x_1</script></span>. We have</p>
<span class="math"><script type="math/tex; mode=display">dx / dt = (x_{\infty} - x) / \tau_x,
</script></span>
<p>where</p>
<span class="math"><script type="math/tex; mode=display">x_{\infty} = \frac{\alpha_x(v)}{\alpha_x(v) + \beta_x(v)},
</script></span>
<p>and</p>
<span class="math"><script type="math/tex; mode=display">\tau_x = \frac{1}{\alpha_x(v) + \beta_x(v)}.
</script></span>
<p>In the code base, <span class="math"><script type="math/tex">x_{\infty}</script></span> and <span class="math"><script type="math/tex">\tau_x</script></span> are calculated in <strong>BeelerReuter.calc_inf_tau()</strong>. All <span class="math"><script type="math/tex">\alpha</script></span>s and <span class="math"><script type="math/tex">\beta</script></span>s are derived using the same equation (of course with different values of <span class="math"><script type="math/tex">C</script></span>s),</p>
<span class="math"><script type="math/tex; mode=display">\alpha = \frac{C_1 e^{C_2(v + C_3)} + C_4(v + C_5) } { e^{C_6(v + C_7) }}.
</script></span>
<p>The values of <span class="math"><script type="math/tex">C</script></span>s are found in the file <strong><a href="http://br.py">br.py</a></strong> as an array <strong>ab_coef</strong> and are used to calculate <span class="math"><script type="math/tex">\alpha</script></span>s and <span class="math"><script type="math/tex">\beta</script></span>s in <strong>BeelerReuter.calc_alpha_beta_np()</strong>. The calculations are done by numpy during the graph definition phase (the <em>setup</em> phase) and are considered constants in the TensorFlow graph. <strong>Ionic.rush_larsen()</strong> updates the gating variables (see <a href="#the-rush-larsen-method">Rush-Larsen</a> method) based on the values of <span class="math"><script type="math/tex">\alpha</script></span>s and <span class="math"><script type="math/tex">\beta</script></span>s.</p>
<p>After updating the gating variables, they are used to find the spontaneous ionic currents. We have</p>
<span class="math"><script type="math/tex; mode=display">i_{Na} = (g_{Na} m^3 h j + g_{NaC})(v - E_{Na}) ,
</script></span>
<p>where <span class="math"><script type="math/tex">g_{Na}</script></span> is the sodium channel conductance, <span class="math"><script type="math/tex">g_{NaC}</script></span> is the sodium/calcium exchanger conductance, and <span class="math"><script type="math/tex">E_{Na}</script></span> is sodium reversal potential. Similarly, for the calcium channel,</p>
<span class="math"><script type="math/tex; mode=display">i_{s} = g_{s} df(v - E_{s}(c)) ,
</script></span>
<p>where <span class="math"><script type="math/tex">g_{s}</script></span> is the calcium current conductance, and <span class="math"><script type="math/tex">E_{s}(c) = -82.3 - 13.0287 \ln (c)</script></span> is the calcium reversal potential explicitly dependent on the intracellular calcium concentration.</p>
<p>To complete the model, we need to calculate the two potassium currents,</p>
<span class="math"><script type="math/tex; mode=display"> i_{K_1} =
        g_{K_1}.\frac{e^{0.04(v+85)}-1}{e^{0.08(v+53)} + e^{0.04(v+53)}} +
        h_{K_1}.\frac{0.2(v+23)}{1 - e^{-0.04(v+23)}},
</script></span>
<p>and,</p>
<span class="math"><script type="math/tex; mode=display">i_{x_1} = g_{x_1} . x_1 . \frac{e^{0.04(v+77)}-1}{e^{0.04(v+35)}},
</script></span>
<p>where <span class="math"><script type="math/tex">g_{K_1}</script></span>, <span class="math"><script type="math/tex">h_{K_1}</script></span>, and <span class="math"><script type="math/tex">g_{x_1}</script></span> are channel conductance. Note that in the code we have used an equivalent form of the last two equations by factoring out the exponentials using an accessory variable <span class="math"><script type="math/tex">k = \exp(0.04v)</script></span>.</p>
<p>We can run the baseline <em>Beeler-Reuter</em> solver as</p>
<pre class="editor-colors lang-text"><span class="syntax--text syntax--plain"><span class="syntax--meta syntax--paragraph syntax--text"><span>python3 br.py</span></span></span>
</pre>
<p>This time, the result looks like this</p>
<p><img src="https://siravan.github.io/fib_tf/br.png" alt=""></p>
<p>The spiral wave anchors to a circular obstacle created by phase field methodology. See <a href="#phase-field">below</a> for details.</p>
<p><strong><a href="http://br.py">br.py</a></strong> already employs most of the optimization steps discuss above (JIT compilation, graph unrolling…). On my computer, this model takes 8.5 seconds per second of simulation compared to 2.8 seconds for the <em>4v</em> model. Considering twice the number of variables and more complicated formulas, a factor of 3 slow down is reasonable.</p>
<p>But we are not done yet! There are still some optimizations tricks that can improve the performance even further. We will discuss three such techniques: the Rush-Larsen method, the Chebyshev polynomials and multi-rate integration. These three methods are already coded in <strong><a href="http://br.py">br.py</a></strong>. You can enable/disable the Chebyshev polynomials and multi-rate integration by editing <strong><a href="http://br.py">br.py</a></strong> (in the <code>if __name__ == '__main__':</code> section on the bottom of the file) and change <code>cheby</code> to <code>True</code> to enable the Chebyshev polynomials or <code>skip</code> to <code>True</code> to enable the multi-rate integration. We can achieve a factor of 2-2.5 speed up by activating both:</p>
<p><a name="table1"><strong>Table 1</strong></a></p>
<table>
<thead>
<tr>
<th></th>
<th>cheby == False</th>
<th>cheby == True</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>skip == False</strong></td>
<td>8.5 s</td>
<td>5.1 s</td>
</tr>
<tr>
<td><strong>skip == True</strong></td>
<td>5.1 s</td>
<td>3.9 s</td>
</tr>
</tbody>
</table>
<h2><a name="the-rush-larsen-method"></a> The Rush-Larsen Method</h2>
<p>Most cardiac electrophysiology ionic ODEs are <em>stiff</em> and require a small integration time step (usually a <span class="math"><script type="math/tex">\Delta{t}</script></span> of 0.01-0.1 millisecond) to have a stable numerical solution. This small time step is necessary to capture the fast changing dynamics at the time of the action potential upstrokes, but is a waste of computational power in other phases of the action potential.</p>
<p>The <a href="https://ieeexplore.ieee.org/document/4122859/">Rush-Larsen</a> method replaces the explicit Euler integration for the gating variables, i.e., <span class="math"><script type="math/tex">x(t+\Delta{t}) = x(t) + \Delta{t}\,x'</script></span>, with direct integration. The starting point is Eq. 19, which describes the dynamic of the gating variables in the Beeler-Reuter and other descendants of the Hodgkin-Huxley model, and is reproduced here by making the dependence on <span class="math"><script type="math/tex">v</script></span> explicit,</p>
<span class="math"><script type="math/tex; mode=display">dx / dt = \left(x_{\infty}(v) - x \right) / \tau_x(v).
</script></span>
<p>If we assume that <span class="math"><script type="math/tex">x</script></span> changes on a faster time-scale than <span class="math"><script type="math/tex">x_{\infty}</script></span> and <span class="math"><script type="math/tex">\tau_x</script></span> (an assumption generally true for the Hodgkin-Huxley type models), we can considered <span class="math"><script type="math/tex">x_{\infty}</script></span> and <span class="math"><script type="math/tex">\tau_x</script></span> constant for the duration of <span class="math"><script type="math/tex">\Delta{t}</script></span> and perform a direct integration of Eq. 27 to obtain</p>
<span class="math"><script type="math/tex; mode=display">x(t + \Delta{t}) = x_{\infty} - (x_{\infty} - x)\,e^{-\Delta{t}/\tau_x}.
</script></span>
<p>This equation is the basis of the Rush-Larsen method and is coded essentially directly in <strong>Ionin.rush_larsen()</strong></p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span class="syntax--meta syntax--function syntax--python"><span class="syntax--storage syntax--type syntax--function syntax--python"><span>def</span></span><span> </span><span class="syntax--entity syntax--name syntax--function syntax--python"><span>rush_larsen</span></span><span class="syntax--punctuation syntax--definition syntax--parameters syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function syntax--parameters syntax--python"><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>self</span></span><span class="syntax--punctuation syntax--separator syntax--parameters syntax--python"><span>,</span></span><span> </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>g</span></span><span class="syntax--punctuation syntax--separator syntax--parameters syntax--python"><span>,</span></span><span> </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>g_inf</span></span><span class="syntax--punctuation syntax--separator syntax--parameters syntax--python"><span>,</span></span><span> </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>g_tau</span></span><span class="syntax--punctuation syntax--separator syntax--parameters syntax--python"><span>,</span></span><span> </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>dt</span></span><span class="syntax--punctuation syntax--separator syntax--parameters syntax--python"><span>,</span></span><span> </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span class="syntax--constant syntax--language syntax--python"><span>None</span></span></span><span class="syntax--punctuation syntax--definition syntax--parameters syntax--end syntax--python"><span>)</span></span><span class="syntax--punctuation syntax--section syntax--function syntax--begin syntax--python"><span>:</span></span></span></span>
<span class="syntax--source syntax--python"><span>    </span><span class="syntax--keyword syntax--control syntax--statement syntax--python"><span>return</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>clip_by_value</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>g_inf</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span>(</span><span>g_inf</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span>g</span><span>)</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>tf</span><span>.</span><span>exp</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span>dt</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>/</span></span><span>g_tau</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>0.0</span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>1.0</span></span><span>, </span><span class="syntax--variable syntax--parameter syntax--function syntax--python"><span>name</span></span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span>name</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<p>It allows for the integration of the Beeler-Reuter model with a time step of 0.1 ms, instead of 0.01 ms without the Rush-Larsen trick. This is a factor 10 improvement! It should be noted that the Rush-Larsen method is a general and standard method for solving cardiac electrophysiology ionic models and is not exclusive to TensorFlow or even GPU.</p>
<h2><a name="using-the-chebyshev-polynomials"></a> Using the Chebyshev Polynomials</h2>
<p>Lookup tables are commonly used to increase the speed of solving systems of ODEs. This method is particularly suitable for solving cardiac ionic models, because the right side of many of the equations describing the dynamics of the models depend only of the transmembrane potential. For example, in the Beeler-Reuter model, the time derivatives of the six gating variables are defined in term of <span class="math"><script type="math/tex">\alpha(v)</script></span> and <span class="math"><script type="math/tex">\beta(v)</script></span>. It is reasonable to calculate <span class="math"><script type="math/tex">\alpha</script></span> and <span class="math"><script type="math/tex">\beta</script></span> for different values of <span class="math"><script type="math/tex">v</script></span> ahead of time and then just perform a table lookup (with some forms of interpolation) to find the desired values while running the model.</p>
<p>It is reasonably straightforward to implement lookup tables running on a CPU in programming languages like C, C++, and Fortran (the historical high-performance computing choices); notwithstanding subtle issues with cache coherence. The situation is more interesting when dealing with GPUs. Lookup tables are located in the global memory. Considering that global memory access is the primary bottleneck of most GPU applications, it is usually more efficient to recalculate the intermediate parameters each time than doing a table lookup. However, GPUs are designed with graphic acceleration in mind and lookup tables are ubiquitous in graphic applications. Therefore, they have specialized hardware to accelerate lookups in the form of <em>texture memory</em>. Unfortunately, at least to best of my knowledge, TensorFlow currently does not have an operation to property initialize and use the texture memory and direct table lookups are exceedingly slow.</p>
<p>It is in this setting that we decided to use <a href="https://en.wikipedia.org/wiki/Chebyshev_polynomials">Chebyshev polynomials</a> to encode the lookup values. Chebyshev polynomials are a valuable tool in numerical analysis and numerical approximation. A disclaimer! We only present the bare minimum needed to advance our discussion and cannot do justice to the large and interesting mathematics of the Chebyshev polynomials.</p>
<p>A Chebyshev polynomial of the first kind <span class="math"><script type="math/tex">T_i(x)</script></span> is a degree <span class="math"><script type="math/tex">i</script></span> polynomial in variable <span class="math"><script type="math/tex">x</script></span>, defined recursively as</p>
<span class="math"><script type="math/tex; mode=display">T_0(x) = 1,
</script></span>
<span class="math"><script type="math/tex; mode=display">T_1(x) = x,
</script></span>
<span class="math"><script type="math/tex; mode=display">T_n(x) = 2xT_{n-1}(x) - T_{n-2}(x)
</script></span>
<p>Few examples,</p>
<span class="math"><script type="math/tex; mode=display">T_2(x) = 2x^2 - 1,
</script></span>
<span class="math"><script type="math/tex; mode=display">T_3(x) = 4x^3 - 3x,
</script></span>
<span class="math"><script type="math/tex; mode=display">T_4(x) = 8x^4 - 8x^2 + 1,
</script></span>
<span class="math"><script type="math/tex; mode=display">T_{10}(x) = 512x^{10} - 1280x^8 + 1120x^6 -400x^4 + 50x^2 - 1.
</script></span>
<p>Chebyshev polynomial are orthogonal on the interval [-1,1] with respect to the weighting factor <span class="math"><script type="math/tex">(1-x^2)^{-1/2}</script></span>,</p>
<span class="math"><script type="math/tex; mode=display">    \int_{-1}^{1} T_n(x)T_m(x)\,\frac{dx}{\sqrt{1-x^2}} =
        \begin{cases}
        0       & \quad n \neq m    \\
        \pi     & \quad n = m = 0   \\
        \pi/2   & \quad n = m \neq 0
        \end{cases}
</script></span>
<p>The Chebyshev polynomials can act as a basis set similar to the trigonometrical functions in the Fourier analysis. Let <span class="math"><script type="math/tex">f(x)</script></span> be a continuous and piecewise smooth function defined on [1,-1]. It can be expressed as</p>
<span class="math"><script type="math/tex; mode=display">    f(x) = \sum_{i=0}^{\infty} c_i T_i(x).
</script></span>
<p>Of course, in practice we use partial sums and truncate the summation after <span class="math"><script type="math/tex">n+1</script></span> terms, where <span class="math"><script type="math/tex">n</script></span> is the order of the leading term. The main benefit of the Chebyshev polynomials compared to other families of orthogonal polynomials is the <em>minimax</em> property, i.e., the partial (truncated) Chebyshev sum <em>minimizes</em> the <em>maximum</em> error, and is therefore better suited for approximation of arbitrary functions.</p>
<p>Chebyshev polynomials are used by most hardwares (the floating-point units) and low-level software libraries to calculate trigonometric and exponential functions. My first interaction with Chebyshev polynomials was while browsing the <a href="http://www.primrosebank.net/computers/zxspectrum/docs/CompleteSpectrumROMDisassemblyThe.pdf">source code</a> of the 8-bit personal home computer <a href="https://en.wikipedia.org/wiki/ZX_Spectrum">ZX Spectrum</a> ROM back in the 1980s. It is still an interesting and educational read!</p>
<p>Back to the Beeler-Reuter solver. We employ the Chebyshev polynomials to approximate <span class="math"><script type="math/tex">g_{\infty}</script></span> and <span class="math"><script type="math/tex">\tau_g</script></span> for the six gating variables. Let’s explore the straightforward way to do this (we will later modify it). Experiments showed that we need to use order 8 or higher polynomials to have a reasonable accuracy in solving the Beeler-Reuter model, but for the sake of simplicity, we use order 4 here to demonstrate the method.</p>
<p>The transmembrane potential ranges between -90 to +30 mV in the Beeler-Reuter model. We remap this range to [-1,1] in <strong>BeelerReuter.update_gates_with_cheby</strong> as</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>x</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>(</span><span>V0</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>0.5</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>(</span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>max_v</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>min_v</span><span>)</span><span>)</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>/</span></span><span> </span><span>(</span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>0.5</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>(</span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>max_v</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--variable syntax--language syntax--self syntax--python"><span>self</span></span><span>.</span><span>min_v</span><span>)</span><span>)</span></span>
</pre>
<p>Note than <span class="math"><script type="math/tex">x</script></span> is a 2D TensorFlow tensor and not a scalar. Next, we can calculate the corresponding Chebyshev polynomials using the recurrence relationship,</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>T0</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>1.0</span></span></span>
<span class="syntax--source syntax--python"><span>T1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>x</span></span>
<span class="syntax--source syntax--python"><span>T2</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T1</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span>T0</span></span>
<span class="syntax--source syntax--python"><span>T3</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T2</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span>T1</span></span>
<span class="syntax--source syntax--python"><span>T4</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T3</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span> </span><span>T2</span></span>
</pre>
<p>Assume the goal is to approximate <span class="math"><script type="math/tex">m_{\infty}</script></span>. We calculate <span class="math"><script type="math/tex">m_{\infty}</script></span> for 5001 points on [-1,1] (5001 is rather an arbitrary number, any number more than few hundred should work fine). Let’s call the result <span class="math"><script type="math/tex">y</script></span>. We estimate the best-fit Chebyshev coefficients as</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>c</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--function-call syntax--python"><span>np</span><span>.</span><span>polynomial</span><span>.</span><span>chebyshev</span><span>.</span><span>Chebyshev</span><span>.</span><span>fit</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span>x</span><span>, </span><span>y</span><span>, </span><span>deg</span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span><span>.</span><span>c</span><span>oef</span></span>
</pre>
<p>Note that <span class="math"><script type="math/tex">c</script></span> is calculated by numpy during the setup stage and the resulting coefficients are considered constants as far as TensorFlow is concerned. Now, we can find the value of <span class="math"><script type="math/tex">m_{\infty}</script></span> at each point as</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>m_inf</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>0</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T1</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T2</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>3</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span>T3</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>4</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>T4</span></span>
</pre>
<p>The figure below shows the actual (orange) and approximated (blue) values for <span class="math"><script type="math/tex">m_{\infty}</script></span>:</p>
<p><img src="https://siravan.github.io/fib_tf/m_inf.png" alt=""></p>
<p>When we tested this method to solve Beeler-Reuter, it worked, but the performance was not that great and it conferred only a modest performance gain. I believe the problem arose because the JIT compiler had difficulty optimizing the <span class="math"><script type="math/tex">T_i</script></span> calculations. The solution is to use <span class="math"><script type="math/tex">S_i</script></span>, the leading term of <span class="math"><script type="math/tex">T_i</script></span>, where <span class="math"><script type="math/tex">S_i</script></span> depends directly only on <span class="math"><script type="math/tex">S_{i-1}</script></span> and not <span class="math"><script type="math/tex">S_{i-2}</script></span>. This seems to help the optimizer avoid unnecessary copying to and back from the global memory. Therefore,</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>S0</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--float syntax--python"><span>1.0</span></span></span>
<span class="syntax--source syntax--python"><span>S1</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>x</span></span>
<span class="syntax--source syntax--python"><span>S2</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S1</span></span>
<span class="syntax--source syntax--python"><span>S3</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S2</span></span>
<span class="syntax--source syntax--python"><span>S4</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>x</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S3</span></span>
</pre>
<p><span class="math"><script type="math/tex">T_i</script></span>s are expanded in term of <span class="math"><script type="math/tex">S_i</script></span>s as</p>
<span class="math"><script type="math/tex; mode=display">T_0 = S_0 = 1
</script></span>
<span class="math"><script type="math/tex; mode=display">T_1 = S_1
</script></span>
<span class="math"><script type="math/tex; mode=display">T_2 = S_2 - 1
</script></span>
<span class="math"><script type="math/tex; mode=display">T_3 = S_3  - 3S_1
</script></span>
<span class="math"><script type="math/tex; mode=display">T_4 = S_4 - 4S_2 + 1
</script></span>
<p>Finally,</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span>m_inf</span><span> </span><span class="syntax--keyword syntax--operator syntax--assignment syntax--python"><span>=</span></span><span> </span><span>(</span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>0</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>4</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span>)</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span>(</span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>1</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>3</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>3</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span>)</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S1</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span>(</span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>2</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>-</span></span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>4</span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>4</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span>)</span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S2</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>3</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span>S3</span><span> </span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>+</span></span><span> </span><span class="syntax--meta syntax--item-access syntax--python"><span>c</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>[</span></span><span class="syntax--meta syntax--item-access syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>4</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>]</span></span></span><span class="syntax--keyword syntax--operator syntax--arithmetic syntax--python"><span>*</span></span><span>S4</span></span>
</pre>
<p>In the code, <strong>BeelerReuter.calc_chebyshev_leading</strong> and <strong>BeelerReuter.expand_chebyshev</strong> do these calculation for arbitrary order polynomials. The resulting code runs 1.5-2X faster than the baseline code.</p>
<h2><a name="multi-rate-integration"></a> Multi-rate Integration</h2>
<p>As it was mentioned above, most cardiac ionic models, including the <em>4v</em> and <em>Beeler-Reuter</em>, are <em>stiff</em>. The main reason is the presence of two or more time scales. An accurate simulation of the fast sodium channel requires a time step of 0.1 ms or smaller, which is too short and wasteful for slower variables.</p>
<p><a href="https://en.wikipedia.org/wiki/Adaptive_stepsize"><em>Adaptive ODE solvers</em></a> are designed to improve the integration speed of such systems. The idea is that we need a fine time step only at and shortly after the upstroke of action potentials, where the fast sodium channels open and then deactivate. The adaptive solvers change the time step dynamically. However, it is very difficult to adopt an adaptive solver to run efficiently on a GPU, let alone as a TensorFlow GPU program.</p>
<p>Multi-rate integration is another way to cut on the number of calculations down per unit of simulated time. The idea is to use different time steps for different state variables. If flag <code>skip</code> is set to <code>True</code>, <strong>BeelerReuter.update_gates_without_cheby</strong> and <strong>BeelerReuter.update_gates_with_cheby</strong> integrate the fast sodium channel gates (<em>m</em> and <em>h</em>) at 0.1 ms; whereas, <span class="math"><script type="math/tex">\Delta{t}</script></span> is 0.5 ms for other gates.</p>
<p>As is seen in <a href="#table1">Table 1</a>, enabling the multi-rate method improves the performance 1.5-2X.</p>
<h1><a name="phase-field"></a> Phase Field</h1>
<p>The finite-difference PDE solvers enjoy the benefit of simplicity, but in their basic form are unable to handle non-rectangular geometries. Traditionally, complex geometries are solved by using the finite element method. However, the finite element method is more involved than the finite-difference method and is difficult to code efficiently for GPUs.</p>
<p>The phase-field methodology is an addition to the finite-difference method to allow handling of non-rectangular boundaries. The phase-field is a <em>smooth</em> scalar field <span class="math"><script type="math/tex">\phi</script></span> that assumes a value of 1 inside and 0 outside the myocardial borders. The baseline reaction-diffusion equation,</p>
<span class="math"><script type="math/tex; mode=display">  \partial V / \partial t = \nabla (D  \nabla V) - \frac {I_{ion}} {C_m},
</script></span>
<p>is modified to</p>
<span class="math"><script type="math/tex; mode=display">  \phi \partial V / \partial t = \nabla (D \phi \nabla V) - \phi \frac {I_{ion}} {C_m}.
</script></span>
<p>For a uniform and isotropic medium, this equation is simplified to</p>
<span class="math"><script type="math/tex; mode=display">  \partial V / \partial t = \frac{1}{\phi} g \nabla \phi \nabla V + g \nabla^2{V} - \frac {I_{ion}} {C_m}.
</script></span>
<p>This is essentially the same as the reaction-diffusion equation with the addition of a term (the first one on the right) that imposes a no-flux boundary condition based on the value of <span class="math"><script type="math/tex">\phi</script></span>.</p>
<p><strong>Ionic.laplace</strong>, with the help of <strong>Ionic.phase_field</strong>, calculates the correction term and adds it to the Laplacian. The phase field itself is modified by <strong>ionic.add_hole_to_phase_field</strong> that places a circular hole in the phase field.</p>
<p>For example, the <code>if __name__ == '__main__'</code> section of <strong><a href="http://br.py">br.py</a></strong> adds a circular hole of radius 40 pixels and centered at (150, 200) to the phase field by calling</p>
<pre class="editor-colors lang-python"><span class="syntax--source syntax--python"><span class="syntax--meta syntax--function-call syntax--python"><span>model</span><span>.</span><span>add_hole_to_phase_field</span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--begin syntax--python"><span>(</span></span><span class="syntax--meta syntax--function-call syntax--arguments syntax--python"><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>150</span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>200</span></span><span>, </span><span class="syntax--constant syntax--numeric syntax--integer syntax--decimal syntax--python"><span>40</span></span></span><span class="syntax--punctuation syntax--definition syntax--arguments syntax--end syntax--python"><span>)</span></span></span></span>
</pre>
<h1><a name="conclusions"></a> Conclusions</h1>
<p><strong>fib_tf</strong> is a TensorFlow application/framework with the goal of testing different ideas and techniques to efficiently solve 2D cardiac electrophysiology models. We show this goal is achievable. In the course of writing the code base, we learned about the advantages and disadvantages of this approach.</p>
<h2>Pros</h2>
<ol>
<li>
<p>Using a scripting language (Python) and a well-tested and solid framework (TensorFlow) improve the productivity of the programmers. Getting a C or C++ CUDA program correct, let alone efficient, is not easy and needs careful testing and frequent iterations. It is relatively easy to program a <em>correct</em> TensorFlow ODE solver. Of course, making it <em>efficient</em> is the problem!</p>
</li>
<li>
<p>TensorFlow integrates nicely with the numpy/scipy stack. For example, look at <strong>BeelerReuter.expand_chebyshev</strong> and see how numpy codes running on CPU during the setup stage intermingles with a TensorFlow graph destined to run on GPU.</p>
</li>
<li>
<p>TensorFlow allows running the code in a heterogeneous environment (partly on CPU, partly on one or more GPUs).</p>
</li>
<li>
<p>TensorFlow utilities (profiler and tensorboard) are very useful in debugging and profiling applications.</p>
</li>
</ol>
<h2>Cons</h2>
<ol>
<li>
<p>TensorFlow is designed primarily for machine learning applications. Some operations which are not relevant to machine learning, but are needed or beneficial for an ODE solver, are not added yet (e.g., a texture memory lookup operation).</p>
</li>
<li>
<p>While TensorFlow is usually programmed in Python, it is not Python (nor it is C++, Java, Go, nor any other programming language that has a TensorFlow API). The graph models and operations are in fact an independent programming language on their own with all the subtly and quirks of programming languages. Some experts consider this a major <a href="https://julialang.org/blog/2017/12/ml&amp;pl">flaw</a>.</p>
</li>
<li>
<p>Even if we assume TensorFlow is an excellent programming language, writing good code is not easy and the programmer needs to master the mental task of switching back and forth between python/numpy and TensorFlow (but it could be fun! see point #2 of Pros).</p>
</li>
</ol>
<p>In summary, I believe TensorFlow is a great tool for the rapid development of complex ODE solvers. Specially, it is very useful in testing new ideas and methods.</p>
<hr>
<p>@2017-2018 <a href="siravan@emory.edu">Shahriar Iravanian</a></p>
  </body>
</html>
